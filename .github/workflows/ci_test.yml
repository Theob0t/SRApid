name: CI Test Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

jobs:
  test-build-and-run:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker Image (Local)
      uses: docker/build-push-action@v4
      with:
        context: .
        load: true  # Loads it into local docker daemon instead of pushing
        tags: srapid:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Prepare Test Data
      run: |
        echo "GSE76511" > test_gse.txt
        mkdir -p output

    - name: Run SRApid (Test Mode)
      # We skip --sra_db and --geo_db to force 'Online Mode' (pysradb)
      # We use --test_limit 20 to download only 20 reads (fast)
      run: |
        docker run --rm \
          -v $(pwd)/test_gse.txt:/data/list.txt \
          -v $(pwd)/output:/data/output \
          srapid:test \
          --gse_list /data/list.txt \
          --out_dir /data/output \
          --cpus 2 \
          --test_limit 20

    - name: Validate Output Structure
      run: |
        echo "Checking outputs..."
        ls -R output/
        
        # 1. Check for Summary CSV
        if [ ! -f "output/GSE_run_counts.csv" ]; then
          echo "❌ Failed: GSE_run_counts.csv not generated."
          exit 1
        fi
        
        # 2. Check for at least one FASTQ file
        # GSE76511 should have data. We check if the folder exists and has content.
        count=$(find output/fastq -name "*_R1.fastq.gz" | wc -l)
        if [ "$count" -gt 0 ]; then
            echo "✅ Success: $count FASTQ files downloaded."
        else
            echo "❌ Failed: No FASTQ files found."
            exit 1
        fi
        
        # 3. Check for Technical Metadata
        if [ ! -f "output/technical_metadata/GSE76511_metadata.csv" ]; then
             echo "❌ Failed: Technical metadata missing."
             exit 1
        fi